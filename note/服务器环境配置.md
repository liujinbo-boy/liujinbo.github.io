

# 系统用户添加 + Samba 映射 + NFS 服务搭建 完整配置手册

## 一、添加部门人员系统账号（以用户 ljb 为例）
### 1.1 创建系统用户并指定家目录
```shell
# -m：自动创建家目录；-s：指定登录shell；-d：自定义家目录路径
sudo useradd -m -s /bin/bash -d /media/bsj/HDD2/hw/ljb ljb
```
### 1.2 设置用户密码
```shell
sudo passwd ljb
# 执行后按提示输入密码（建议与Samba密码区分）
```


## 二、Samba 服务安装与共享配置（Windows 访问支持）
### 2.1 安装 Samba 依赖包（Debian/Ubuntu）
```shell
sudo apt update && sudo apt install -y samba samba-common-bin
```

### 2.2 配置 Samba 共享目录
#### 2.2.1 编辑核心配置文件
```shell
sudo vim /etc/samba/smb.conf
```

#### 2.2.2 添加共享规则（文件末尾追加）
```ini
[ljb]
comment = Shared directory for department
path = /media/bsj/HDD2/hw/ljb
browseable = yes
writable = yes
valid users = ljb
create mask = 0755
directory mask = 0775
force user = ljb
force group = ljb
valid users = ljb
```
> ⚠️ 注意：配置中不要保留注释，避免语法解析错误

### 2.3 添加 Samba 授权用户（需与系统用户同名）
```shell
# 将系统用户 ljb 加入 Samba 用户库，设置独立访问密码
sudo smbpasswd -a ljb
```

### 2.4 配置共享目录权限（关键步骤）
```shell
# 授予 ljb 用户对共享目录的读写执行权限
sudo chmod -R 775 /media/bsj/HDD2/hw/ljb
# 绑定目录所属用户组为 ljb
sudo chown -R ljb:ljb /media/bsj/HDD2/hw/ljb
```

### 2.5 启动并设置 Samba 开机自启
```shell
# 重启 Samba 服务使配置生效
sudo systemctl restart smbd nmbd
# 设置开机自动启动
sudo systemctl enable smbd nmbd
```

### 2.6 Samba 服务验证与问题排查
```shell
# 1. 检查服务运行状态（active(running) 为正常）
sudo systemctl status smbd nmbd

# 2. 验证 Samba 用户是否存在（替换 ljb 为目标用户名）
sudo pdbedit -L -v | grep ljb

# 3. 本地测试访问（替换 ljb 为目标用户名）
smbclient //localhost/ljb -U ljb
# 输入密码后进入交互界面，说明认证成功
```

---

## 三、NFS 文件系统搭建（跨设备 Linux 共享）
> 📌 核心概念：NFS 分「服务端」（提供共享目录）和「客户端」（挂载共享目录）

### 3.1 NFS 服务端配置（提供共享）
#### 3.1.1 安装 NFS 服务端软件
```shell
sudo apt update && sudo apt install -y nfs-kernel-server
```

#### 3.1.2 创建共享目录（示例路径 /nfs，可自定义）
```shell
# 创建目录（-p 确保父目录不存在时自动创建）
sudo mkdir -p /nfs
# 设置目录权限（允许客户端读写）
sudo chmod -R 755 /nfs
sudo chown -R nobody:nobody /nfs
```

#### 3.1.3 配置 NFS 共享规则
```shell
# 编辑 exports 配置文件
sudo vim /etc/exports
```

在文件末尾添加以下规则（二选一，根据网络环境选择）：
```ini
# 示例1：仅允许 192.168.1.0/24 网段设备访问（推荐，安全性更高）
/nfs 192.168.1.0/24(rw,sync,no_root_squash,no_subtree_check)

# 示例2：允许所有设备访问（测试环境使用，不推荐生产环境）
# /nfs *(rw,sync,no_root_squash,no_subtree_check)
```

#### 3.1.4 规则参数说明
| 参数            | 作用说明                                  |
|-----------------|-------------------------------------------|
| rw              | 允许客户端读写（ro 为只读权限）           |
| sync            | 数据实时写入磁盘，保证数据一致性（推荐）  |
| no_root_squash  | 允许客户端 root 用户保持权限（谨慎使用）  |
| no_subtree_check| 关闭子目录检查，提升 NFS 服务稳定性       |

#### 3.1.5 启动 NFS 服务并设置自启
```shell
# 启动 NFS 服务
sudo systemctl start nfs-kernel-server
# 设置开机自启
sudo systemctl enable nfs-kernel-server
```

#### 3.1.6 开放防火墙端口（客户端可访问的关键）
```shell
# UFW 防火墙（Ubuntu 默认）放行 NFS 服务
sudo ufw allow nfs
# 重启防火墙使规则生效
sudo ufw reload
```
> 📌 备选方案：测试环境可直接关闭防火墙 `sudo ufw disable`

#### 3.1.7 服务端验证共享是否生效
```shell
# 列出本地已共享的 NFS 目录
showmount -e localhost
# 输出包含 "/nfs 192.168.1.0/24" 即为配置成功
```

#### 3.1.8 服务端问题排查
```shell
# 若共享未生效或客户端无法连接，重启 NFS 服务
sudo systemctl restart nfs-kernel-server
```

### 3.2 NFS 客户端配置（挂载共享目录）
#### 3.2.1 安装 NFS 客户端工具
```shell
sudo apt update && sudo apt install -y nfs-common
```

#### 3.2.2 创建本地挂载点（自定义路径）
```shell
sudo mkdir -p /mnt/nfs_mount
```

#### 3.2.3 临时挂载 NFS 共享（重启后失效）
```shell
# 格式：sudo mount -t nfs -o nolock 服务端IP:共享目录 客户端挂载点
sudo mount -t nfs -o nolock 192.168.100.4:/nfs /mnt/nfs_mount
```
> 替换说明：
> - `192.168.100.4`：替换为你的 NFS 服务端实际 IP
> - `/nfs`：服务端共享目录路径
> - `/mnt/nfs_mount`：客户端本地挂载点路径

#### 3.2.4 版本兼容性说明
```shell
# 查看服务端支持的 NFS 版本
cat /proc/fs/nfsd/versions
```
⚠️ 注意：Linux 内核 6.x 不支持 NFS v2，需确保服务端和客户端版本一致（推荐 v3/v4）

